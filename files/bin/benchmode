#!/bin/bash

# Use ASR flag to determine if we're currently in benchmark mode
asr_active=$(cat "/proc/sys/kernel/randomize_va_space")

# Print current benchmark mode
function status {
    if [[ "$asr_active" == "0" ]]; then
        echo -e "Benchmark mode is \e[32menabled\e[0m"
    else
        echo -e "Benchmark mode is \e[31mdisabled\e[0m"
    fi
}

command="$1"

# Toggle current benchmark state
if [[ "$1" == "toggle" ]]; then
    if [[ "$asr_active" == "0" ]]; then
        command="disable"
    else
        command="enable"
    fi
fi

if [[ "$command" == "disable" ]]; then
    # Sanity check current state
    if [[ "$asr_active" == "2" ]]; then
        echo -e "Benchmark mode already \e[31mdisabled\e[0m"
        exit
    fi

    # Enable ASR
    echo "2" | sudo tee /proc/sys/kernel/randomize_va_space > /dev/null

    # Set CPU governor to powersave mode
    echo "schedutil" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null

    echo -e "\e[31mDisabled\e[0m benchmark mode"
elif [[ "$command" == "enable" ]]; then
    # Sanity check current state
    if [[ "$asr_active" == "0" ]]; then
        echo -e "Benchmark mode already \e[32menabled\e[0m"
        exit
    fi

    # Disable ASR
    echo "0" | sudo tee /proc/sys/kernel/randomize_va_space > /dev/null

    # Set CPU governor to performance mode
    echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null

    echo -e "\e[32mEnabled\e[0m benchmark mode"
elif [[ "$1" == "status" ]]; then
    status
else
    # Print error message only with invalid subcommand
    if [[ -n "$1" ]] && [[ "$1" != "help" ]] && [[ "$1" != "--help" ]] && [[ "$1" != "-h" ]]; then
        echo "Unknown subcommand '$1'"
        echo
    fi

    # Print current benchmark mode status
    status

    echo

    # Print usage help
    echo "USAGE:"
    echo "    benchmode [SUBCOMMAND]"
    echo
    echo "SUBCOMMANDS:"
    echo "    enable     Enable benchmark mode"
    echo "    disable    Disable benchmark mode"
    echo "    toggle     Toggle benchmark mode"
    echo "    status     Print current mode"
    echo "    help       Print this message"
fi
